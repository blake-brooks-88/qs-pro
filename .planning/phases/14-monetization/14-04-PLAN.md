---
phase: 14-monetization
plan: 04
type: execute
wave: 3
depends_on: ["14-03"]
files_modified:
  - apps/web/src/hooks/use-trial.ts
  - apps/web/src/hooks/__tests__/use-trial.test.ts
  - apps/web/src/config/urls.ts
  - apps/web/src/components/TrialBanner.tsx
  - apps/web/src/components/TrialExpiredBanner.tsx
  - apps/web/src/components/UpgradeModal.tsx
  - apps/web/src/components/app-shell.tsx
  - apps/web/src/App.tsx
  - apps/web/src/components/__tests__/TrialBanner.test.tsx
  - apps/web/src/components/__tests__/TrialExpiredBanner.test.tsx
  - apps/web/src/components/__tests__/UpgradeModal.test.tsx
autonomous: true
must_haves:
  truths:
    - "Trial countdown banner shows during last 5 days of trial with days remaining"
    - "Trial countdown banner is dismissible (session-scoped, resets on page reload)"
    - "Trial expired banner shows after trial ends with soft message and pricing page link"
    - "Trial expired banner is dismissible"
    - "No banner shows during days 1-9 of trial (quiet period)"
    - "No banner shows for paid subscribers"
    - "UpgradeModal CTA opens external pricing page in new tab (not a toast placeholder)"
    - "All upgrade CTAs link to pricing page (fewest clicks per user decision)"
    - "App.tsx passes trial banner into AppShell topNotice prop for layout integration"
    - "useTrial hook correctly derives all trial states from features query"
  artifacts:
    - path: "apps/web/src/hooks/use-trial.ts"
      provides: "Trial state hook for components"
      exports: ["useTrial"]
    - path: "apps/web/src/hooks/__tests__/use-trial.test.ts"
      provides: "Unit tests for useTrial hook business logic"
      contains: "useTrial"
    - path: "apps/web/src/config/urls.ts"
      provides: "Centralized external URL constants"
      exports: ["PRICING_PAGE_URL", "buildPricingUrl"]
    - path: "apps/web/src/components/TrialBanner.tsx"
      provides: "Countdown banner for last 5 days of trial"
      exports: ["TrialBanner"]
    - path: "apps/web/src/components/TrialExpiredBanner.tsx"
      provides: "Post-trial dismissible banner"
      exports: ["TrialExpiredBanner"]
    - path: "apps/web/src/components/UpgradeModal.tsx"
      provides: "Updated UpgradeModal with pricing page CTA"
      contains: "window.open"
  key_links:
    - from: "apps/web/src/hooks/use-trial.ts"
      to: "apps/web/src/hooks/use-tenant-features.ts"
      via: "Reads trial state from existing features query"
      pattern: "useTenantFeatures"
    - from: "apps/web/src/components/TrialBanner.tsx"
      to: "apps/web/src/hooks/use-trial.ts"
      via: "useTrial hook for countdown data"
      pattern: "useTrial"
    - from: "apps/web/src/App.tsx"
      to: "apps/web/src/components/TrialBanner.tsx"
      via: "Renders TrialBanner/TrialExpiredBanner into AppShell topNotice prop"
      pattern: "topNotice.*TrialBanner|TrialExpiredBanner"
    - from: "apps/web/src/App.tsx"
      to: "apps/web/src/components/app-shell.tsx"
      via: "Passes topNotice prop to AppShell"
      pattern: "topNotice="
    - from: "apps/web/src/components/UpgradeModal.tsx"
      to: "external pricing page"
      via: "window.open to pricing URL with eid"
      pattern: "window\\.open"
    - from: "apps/web/src/config/urls.ts"
      to: "apps/web/src/store/auth-store.ts"
      via: "buildPricingUrl reads tenant eid from auth store"
      pattern: "useAuthStore|eid"
---

<objective>
Build the frontend trial UX and update upgrade CTAs to link to the external pricing page.

Purpose: The monetization UX must feel fair, not punitive (per user's specific guidance). Trial countdown appears only in the last 5 days (quiet during days 1-9). Trial expiry is a soft landing -- dismissible banner, not a modal gate. All upgrade paths lead to the external pricing page via Stripe Checkout, with the tenant's eid passed as a URL parameter so the external site can embed it in the Stripe Checkout session metadata.

Output: useTrial hook, TrialBanner (countdown), TrialExpiredBanner (soft landing), updated UpgradeModal, App.tsx layout integration via topNotice prop, centralized pricing URL with eid, and component + hook tests.
</objective>

<execution_context>
@/home/blakebrooks-88/.claude/get-shit-done/workflows/execute-plan.md
@/home/blakebrooks-88/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-monetization/14-CONTEXT.md
@.planning/phases/14-monetization/14-RESEARCH.md
@.planning/phases/14-monetization/14-03-SUMMARY.md
@apps/web/src/App.tsx
@apps/web/src/components/app-shell.tsx
@apps/web/src/hooks/use-tier.ts
@apps/web/src/hooks/use-tenant-features.ts
@apps/web/src/components/UpgradeModal.tsx
@apps/web/src/store/auth-store.ts
@packages/shared-types/src/features.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useTrial hook, pricing URL utility, TrialBanner, TrialExpiredBanner, and integrate into App.tsx layout</name>
  <files>
    apps/web/src/hooks/use-trial.ts
    apps/web/src/config/urls.ts
    apps/web/src/components/TrialBanner.tsx
    apps/web/src/components/TrialExpiredBanner.tsx
    apps/web/src/components/app-shell.tsx
    apps/web/src/App.tsx
  </files>
  <action>
    **Step 1: Create apps/web/src/hooks/use-trial.ts**

    Hook that derives trial state from the existing features query (no new API call):

    ```typescript
    import { useTenantFeatures } from "@/hooks/use-tenant-features";

    export function useTrial() {
      const { data, isLoading } = useTenantFeatures();

      const trial = data?.trial ?? null;
      const isTrialActive = trial?.active ?? false;
      const daysRemaining = trial?.daysRemaining ?? null;
      const endsAt = trial?.endsAt ?? null;

      // Show countdown only in last 5 days (per user decision: quiet during days 1-9)
      const showCountdown = isTrialActive
        && typeof daysRemaining === "number"
        && daysRemaining <= 5;

      // Trial expired when: trial exists, is not active, and user is on free tier
      const isTrialExpired = trial !== null
        && !trial.active
        && data?.tier === "free";

      return {
        isTrialActive,
        daysRemaining,
        showCountdown,
        isTrialExpired,
        endsAt,
        isLoading,
      };
    }
    ```

    **Step 2: Create apps/web/src/config/urls.ts**

    Centralized external URL constants. The pricing page URL must include the tenant's `eid` (Enterprise ID) as a query parameter so the external website can embed it in the Stripe Checkout session metadata. This is how the Stripe webhook (Plan 14-02) resolves which tenant to provision after payment.

    ```typescript
    const PRICING_PAGE_BASE = "https://queryplusplus.com/pricing";

    export const PRICING_PAGE_URL = PRICING_PAGE_BASE;

    /**
     * Build pricing page URL with tenant eid for Stripe Checkout identification.
     * The external pricing page embeds this eid in Stripe session metadata,
     * which the webhook handler uses to resolve the tenant after payment.
     */
    export function buildPricingUrl(eid: string): string {
      const url = new URL(PRICING_PAGE_BASE);
      url.searchParams.set("eid", eid);
      return url.toString();
    }
    ```

    Export both: `PRICING_PAGE_URL` for cases where eid is unavailable (unlikely but safe fallback), and `buildPricingUrl(eid)` as the primary function used by all CTAs.

    **Step 3: Create apps/web/src/components/TrialBanner.tsx**

    Persistent dismissible banner at the top of the app. Only renders when `showCountdown` is true.

    Design:
    - Slim banner bar (h-10 or similar) at the very top of the app layout
    - Background: subtle primary/brand color (e.g., bg-primary/10 or bg-blue-50 dark:bg-blue-950/30)
    - Text: "Your Pro trial ends in N days. Upgrade to keep all features."
    - CTA button: "View Plans" links directly to pricing page (window.open with buildPricingUrl(eid), new tab, noopener,noreferrer)
    - Dismiss button: X icon on the right
    - Session-scoped dismiss: Use useState (not localStorage/Zustand persist). Per user decision, banner resets on page reload (default React state behavior).

    Props:
    - daysRemaining: number
    - pricingUrl: string
    - onDismiss: () => void

    Use existing UI primitives:
    - Button from @/components/ui/button (ghost variant for dismiss)
    - CloseCircle or similar from @solar-icons/react for dismiss icon

    The banner should NOT be aggressive or punitive. Tone: informational, helpful. No alarm colors (no red). Use the brand color or a gentle blue.

    When daysRemaining is 1, show "Your Pro trial ends tomorrow" (not "1 days"). When 0, show "Your Pro trial ends today".

    **Step 4: Create apps/web/src/components/TrialExpiredBanner.tsx**

    Soft landing banner shown after trial expires. Only renders when `isTrialExpired` is true.

    Design:
    - Same slim banner style as TrialBanner
    - Background: neutral/muted (e.g., bg-muted or bg-yellow-50/50 dark:bg-yellow-950/20)
    - Text: "Your Pro trial has ended. Upgrade to restore all features."
    - CTA button: "View Plans" links to pricing page (window.open with buildPricingUrl(eid), new tab)
    - Dismiss button: X icon
    - Session-scoped dismiss (useState)

    Tone: matter-of-fact, not punitive. The app is fully usable at Free tier -- this is just a reminder.

    Props:
    - pricingUrl: string
    - onDismiss: () => void

    **Step 5: Make AppShell topNotice wrapper styling neutral in apps/web/src/components/app-shell.tsx**

    The current topNotice wrapper has hard-coded amber styling (`bg-amber-50 text-amber-900 dark:bg-amber-950/30 dark:text-amber-200`). This conflicts with the TrialBanner's brand color and TrialExpiredBanner's muted styling. Change the topNotice wrapper to be a neutral structural container so each banner controls its own appearance.

    Replace:
    ```tsx
    {topNotice ? (
      <div className="border-b border-border bg-amber-50 text-amber-900 dark:bg-amber-950/30 dark:text-amber-200 px-4 py-2 text-xs">
        {topNotice}
      </div>
    ) : null}
    ```

    With:
    ```tsx
    {topNotice ?? null}
    ```

    The banner components themselves provide their own container div with border-b, padding, and colors. This makes the topNotice slot reusable for any future banner type without style conflicts.

    **Step 6: Integrate banners into App.tsx via topNotice prop**

    In `apps/web/src/App.tsx`, the authenticated view renders `<AppShell>`. Update this section to pass the trial banners via the `topNotice` prop.

    Add imports at the top of App.tsx:
    ```typescript
    import { TrialBanner } from "@/components/TrialBanner";
    import { TrialExpiredBanner } from "@/components/TrialExpiredBanner";
    import { useTrial } from "@/hooks/use-trial";
    import { buildPricingUrl } from "@/config/urls";
    ```

    Inside the `App` function, before the return statement for the authenticated view, add:
    ```typescript
    const { showCountdown, isTrialExpired, daysRemaining } = useTrial();
    const [bannerDismissed, setBannerDismissed] = useState(false);
    ```

    Read the tenant's eid from the auth store:
    ```typescript
    const tenant = useAuthStore((s) => s.tenant);
    const pricingUrl = tenant?.eid ? buildPricingUrl(tenant.eid) : PRICING_PAGE_URL;
    ```

    Build the topNotice element:
    ```typescript
    const topNotice = (() => {
      if (bannerDismissed) return undefined;
      if (showCountdown && daysRemaining !== null) {
        return (
          <TrialBanner
            daysRemaining={daysRemaining}
            pricingUrl={pricingUrl}
            onDismiss={() => setBannerDismissed(true)}
          />
        );
      }
      if (isTrialExpired) {
        return (
          <TrialExpiredBanner
            pricingUrl={pricingUrl}
            onDismiss={() => setBannerDismissed(true)}
          />
        );
      }
      return undefined;
    })();
    ```

    Then pass it to AppShell:
    ```tsx
    <AppShell
      topNotice={topNotice}
      brandingExtra={import.meta.env.DEV ? <DevTierSelector /> : undefined}
    >
    ```

    Note: useTrial and useState must be called at the component top level (not conditionally). They should be placed alongside existing hooks in the App function, before the early returns for loading/error/unauthenticated states. The hooks are cheap no-ops when the user is unauthenticated (useTenantFeatures returns no data, useTrial returns defaults).

    IMPORTANT: Only ONE banner shows at a time. showCountdown and isTrialExpired are mutually exclusive (trial can't be both active and expired).
  </action>
  <verify>
    - `pnpm typecheck` passes
    - `pnpm lint` passes
    - `pnpm --filter @qpp/web build` succeeds
    - Banners render correctly in the layout (visual check via dev server if possible)
    - Dismiss button hides banner for the session
    - "View Plans" button opens pricing page in new tab with eid parameter
    - AppShell topNotice no longer applies amber styling (banners own their styling)
  </verify>
  <done>
    useTrial hook derives trial state from existing features query. TrialBanner shows countdown during last 5 days. TrialExpiredBanner shows soft landing message after expiry. Both are dismissible and integrated into App.tsx via AppShell topNotice prop. AppShell topNotice wrapper is now a neutral container. External pricing page URL includes tenant eid for Stripe Checkout identification.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update UpgradeModal CTA, add useTrial hook tests, and add component tests</name>
  <files>
    apps/web/src/components/UpgradeModal.tsx
    apps/web/src/hooks/__tests__/use-trial.test.ts
    apps/web/src/components/__tests__/TrialBanner.test.tsx
    apps/web/src/components/__tests__/TrialExpiredBanner.test.tsx
    apps/web/src/components/__tests__/UpgradeModal.test.tsx
  </files>
  <action>
    **Step 1: Update apps/web/src/components/UpgradeModal.tsx**

    Replace the placeholder toast with an actual pricing page link:

    Change the "Upgrade to Pro" button's onClick from:
    ```typescript
    toast.info("Coming soon -- Pro subscription launching soon!");
    ```
    to:
    ```typescript
    window.open(pricingUrl, "_blank", "noopener,noreferrer");
    ```

    The UpgradeModal needs access to the pricing URL with eid. Either:
    - Accept a `pricingUrl` prop (preferred -- keeps component pure), or
    - Read from auth store internally using buildPricingUrl

    Use the prop approach: add `pricingUrl: string` to UpgradeModalProps. The parent components that render UpgradeModal will build the URL using buildPricingUrl(eid). Import PRICING_PAGE_URL as fallback for cases where eid is not available.

    Remove the `toast` import if it's no longer used in this file (remove unused imports per project conventions).

    The rest of the UpgradeModal (Pro benefits list, Crown icon, "Maybe later" button) stays the same. The modal is already well-designed and matches the existing UI patterns.

    IMPORTANT: Update all existing call sites that render UpgradeModal to pass the new `pricingUrl` prop. Search for `<UpgradeModal` across the codebase and update each occurrence.

    **Step 2: Create apps/web/src/hooks/__tests__/use-trial.test.ts**

    Test the useTrial hook business logic. Use renderHook from @testing-library/react with a wrapper that provides the TanStack QueryClient.

    Mock useTenantFeatures to return controlled data. Test cases:

    1. **Active trial, day 3 (within countdown)**: features data has trial { active: true, daysRemaining: 3, endsAt: "..." }, tier: "pro". Verify: showCountdown=true, isTrialExpired=false, daysRemaining=3.
    2. **Active trial, day 8 (quiet period)**: trial { active: true, daysRemaining: 8 }. Verify: showCountdown=false (daysRemaining > 5), isTrialActive=true.
    3. **Active trial, day 5 (boundary)**: trial { active: true, daysRemaining: 5 }. Verify: showCountdown=true (5 <= 5).
    4. **Active trial, day 6 (just outside)**: trial { active: true, daysRemaining: 6 }. Verify: showCountdown=false (6 > 5).
    5. **Expired trial, free tier**: trial { active: false, daysRemaining: 0 }, tier: "free". Verify: isTrialExpired=true, showCountdown=false.
    6. **Expired trial, paid tier**: trial { active: false, daysRemaining: 0 }, tier: "pro". Verify: isTrialExpired=false (they paid, so no expired banner).
    7. **No trial (paid subscriber)**: trial: null, tier: "pro". Verify: isTrialExpired=false, showCountdown=false, isTrialActive=false.
    8. **Loading state**: data is undefined (loading). Verify: isLoading=true, all booleans false.
    9. **Trial null (no subscription)**: trial: null, tier: "free". Verify: isTrialExpired=false (trial was never started).

    **Step 3: Create apps/web/src/components/__tests__/TrialBanner.test.tsx**

    Test cases:
    1. **Renders countdown text**: Given daysRemaining=3, renders "Your Pro trial ends in 3 days."
    2. **Day 1 phrasing**: Given daysRemaining=1, renders "Your Pro trial ends tomorrow."
    3. **Day 0 phrasing**: Given daysRemaining=0, renders "Your Pro trial ends today."
    4. **View Plans button**: Clicking "View Plans" calls window.open with the pricingUrl prop value.
    5. **Dismiss button**: Clicking dismiss calls onDismiss callback.

    Mock window.open with vi.fn().

    **Step 4: Create apps/web/src/components/__tests__/TrialExpiredBanner.test.tsx**

    Test cases:
    1. **Renders expiry text**: Renders "Your Pro trial has ended" message.
    2. **View Plans button**: Clicking "View Plans" calls window.open with the pricingUrl prop value.
    3. **Dismiss button**: Clicking dismiss calls onDismiss callback.

    **Step 5: Create apps/web/src/components/__tests__/UpgradeModal.test.tsx**

    If a test file already exists, update it. Otherwise create it.

    Test cases:
    1. **Renders when open**: When isOpen=true, modal content is visible.
    2. **Pro benefits listed**: All 7 Pro benefits are rendered.
    3. **Upgrade button opens pricing page**: Clicking "Upgrade to Pro" calls window.open with the pricingUrl prop value (NOT a toast).
    4. **Maybe later closes modal**: Clicking "Maybe later" calls onClose.
    5. **Not rendered when closed**: When isOpen=false, modal content is not visible.

    Mock window.open with vi.fn(). Follow existing test patterns (render, screen.getByText, fireEvent/userEvent).

    Use @testing-library/react with the existing test setup. Check for existing test utilities in @qpp/test-utils that might be relevant (QueryClient wrapper, etc.).
  </action>
  <verify>
    - `pnpm typecheck` passes
    - `pnpm --filter @qpp/web test` passes (all existing + new tests)
    - `pnpm lint` passes
    - UpgradeModal no longer shows toast (verify by checking no toast.info import)
    - window.open called with correct URL in tests
    - useTrial hook tests cover all 9 state permutations
  </verify>
  <done>
    UpgradeModal CTA opens external pricing page with eid (replaces placeholder toast). useTrial hook has unit tests covering all trial states including boundary conditions. TrialBanner, TrialExpiredBanner, and UpgradeModal all have component tests. All upgrade paths lead to the pricing page with tenant identification.
  </done>
</task>

</tasks>

<verification>
- `pnpm typecheck` passes
- `pnpm test` passes (all packages)
- `pnpm lint` passes
- `pnpm --filter @qpp/web build` succeeds
- Trial countdown banner shows only during last 5 days
- Trial expired banner shows soft landing message
- Both banners are dismissible (session-scoped)
- UpgradeModal opens pricing page in new tab with eid
- AppShell topNotice is a neutral container (no amber override)
- App.tsx passes banners to AppShell via topNotice prop
- No aggressive or punitive monetization UX
</verification>

<success_criteria>
- useTrial hook correctly derives trial state from features query
- useTrial hook has unit tests covering all state permutations
- TrialBanner countdown: "N days" for 2+, "tomorrow" for 1, "today" for 0
- TrialExpiredBanner: soft landing, dismissible, links to pricing
- UpgradeModal: CTA opens external pricing page with eid (no more placeholder toast)
- No banners during trial days 1-9 (quiet period)
- No banners for paid subscribers
- App.tsx integrates banners via AppShell topNotice prop
- AppShell topNotice wrapper has no hard-coded amber styling
- Pricing URL includes tenant eid for Stripe Checkout identification
- All components and hooks have tests
- All existing web tests continue to pass
</success_criteria>

<output>
After completion, create `.planning/phases/14-monetization/14-04-SUMMARY.md`
</output>
