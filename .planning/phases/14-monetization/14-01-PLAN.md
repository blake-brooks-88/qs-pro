---
phase: 14-monetization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/database/src/schema.ts
  - packages/database/src/interfaces/index.ts
  - packages/database/src/repositories/drizzle-repositories.ts
  - packages/database/drizzle/0031_org_subscriptions.sql
  - packages/database/drizzle/0032_stripe_webhook_events.sql
  - packages/database/drizzle/0033_migrate_existing_tenants.sql
  - packages/backend-shared/src/config/env.schema.ts
  - packages/shared-types/src/features.ts
autonomous: true
must_haves:
  truths:
    - "org_subscriptions table exists with tenantId (unique), stripe fields, tier, seatLimit, trialEndsAt, currentPeriodEnds"
    - "stripe_webhook_events table exists for idempotent webhook processing"
    - "IOrgSubscriptionRepository interface and Drizzle implementation exist"
    - "Stripe env vars (STRIPE_SECRET_KEY, STRIPE_WEBHOOK_SECRET) validated at API startup"
    - "TenantFeaturesResponse includes trial state (active, daysRemaining, endsAt)"
    - "Existing tenants data migrated to org_subscriptions rows"
  artifacts:
    - path: "packages/database/src/schema.ts"
      provides: "org_subscriptions and stripe_webhook_events table definitions"
      contains: "orgSubscriptions"
    - path: "packages/database/src/interfaces/index.ts"
      provides: "IOrgSubscriptionRepository interface"
      contains: "IOrgSubscriptionRepository"
    - path: "packages/database/src/repositories/drizzle-repositories.ts"
      provides: "DrizzleOrgSubscriptionRepository implementation"
      contains: "DrizzleOrgSubscriptionRepository"
    - path: "packages/backend-shared/src/config/env.schema.ts"
      provides: "Stripe env var validation schema"
      contains: "STRIPE_SECRET_KEY"
    - path: "packages/shared-types/src/features.ts"
      provides: "TrialStateSchema and extended TenantFeaturesResponse"
      contains: "TrialStateSchema"
  key_links:
    - from: "packages/database/src/interfaces/index.ts"
      to: "packages/database/src/schema.ts"
      via: "type inference from orgSubscriptions table"
      pattern: "orgSubscriptions\\.\\$inferSelect"
    - from: "packages/database/src/repositories/drizzle-repositories.ts"
      to: "packages/database/src/schema.ts"
      via: "Drizzle queries against orgSubscriptions"
      pattern: "from\\(orgSubscriptions\\)"
---

<objective>
Create the database foundation and shared type schemas for the monetization system.

Purpose: Every downstream plan (billing, trial, features refactor, frontend) depends on the org_subscriptions table, repository interface, Stripe env vars, and extended features response type. This plan establishes all shared data contracts.

Output: New database tables with migrations, repository interface + implementation, Stripe env validation, and extended shared-types schemas.
</objective>

<execution_context>
@/home/blakebrooks-88/.claude/get-shit-done/workflows/execute-plan.md
@/home/blakebrooks-88/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-monetization/14-CONTEXT.md
@.planning/phases/14-monetization/14-RESEARCH.md
@packages/database/src/schema.ts
@packages/database/src/interfaces/index.ts
@packages/database/src/repositories/drizzle-repositories.ts
@packages/backend-shared/src/config/env.schema.ts
@packages/shared-types/src/features.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add org_subscriptions and stripe_webhook_events tables with repository</name>
  <files>
    packages/database/src/schema.ts
    packages/database/src/interfaces/index.ts
    packages/database/src/repositories/drizzle-repositories.ts
  </files>
  <action>
    **In packages/database/src/schema.ts:**

    Add `orgSubscriptions` table after the `tenants` table definition. Per user decision, this is a normalized org-level subscription table. Fields:
    - id: uuid PK (defaultRandom)
    - tenantId: uuid FK to tenants.id, NOT NULL, UNIQUE (one subscription per org)
    - stripeCustomerId: varchar, nullable (null during trial)
    - stripeSubscriptionId: varchar, nullable (null during trial)
    - tier: varchar typed as "free" | "pro" | "enterprise", default "free", NOT NULL
    - seatLimit: integer, nullable (null = unlimited)
    - trialEndsAt: timestamp, nullable (null = not on trial)
    - currentPeriodEnds: timestamp, nullable (null = no active subscription)
    - createdAt: timestamp defaultNow NOT NULL
    - updatedAt: timestamp defaultNow NOT NULL

    Add index on tenantId (unique constraint handles lookup, but explicit index aids JOINs).

    Add `stripeWebhookEvents` table for idempotent webhook processing:
    - id: varchar PK (Stripe event ID, e.g., "evt_xxx")
    - eventType: varchar NOT NULL
    - status: varchar typed as "processing" | "completed" | "failed", default "processing", NOT NULL
    - processedAt: timestamp defaultNow NOT NULL
    - completedAt: timestamp, nullable
    - errorMessage: text, nullable

    Add Zod validation schemas for both tables (createSelectSchema, createInsertSchema) following existing pattern.

    **In packages/database/src/interfaces/index.ts:**

    Add types inferred from the new tables:
    ```typescript
    export type OrgSubscription = typeof orgSubscriptions.$inferSelect;
    export type NewOrgSubscription = typeof orgSubscriptions.$inferInsert;
    export type StripeWebhookEvent = typeof stripeWebhookEvents.$inferSelect;
    export type NewStripeWebhookEvent = typeof stripeWebhookEvents.$inferInsert;
    ```

    Add IOrgSubscriptionRepository interface with ALL methods needed by downstream plans:
    ```typescript
    export interface IOrgSubscriptionRepository {
      findByTenantId(tenantId: string): Promise<OrgSubscription | undefined>;
      findByStripeCustomerId(stripeCustomerId: string): Promise<OrgSubscription | undefined>;
      upsert(subscription: NewOrgSubscription): Promise<OrgSubscription>;
      insertIfNotExists(subscription: NewOrgSubscription): Promise<boolean>;
      updateTierByTenantId(tenantId: string, tier: "free" | "pro" | "enterprise"): Promise<void>;
      updateFromWebhook(tenantId: string, data: Partial<OrgSubscription>): Promise<void>;
    }
    ```

    Note: `findByStripeCustomerId` is required by Plan 14-02's WebhookHandlerService for `customer.subscription.deleted` event handling (finding the org by Stripe customer ID). `insertIfNotExists` is required by Plan 14-03's TrialService for race-safe trial activation.

    Add IStripeWebhookEventRepository interface:
    ```typescript
    export interface IStripeWebhookEventRepository {
      markProcessing(eventId: string, eventType: string): Promise<boolean>;
      markCompleted(eventId: string): Promise<void>;
      markFailed(eventId: string, errorMessage: string): Promise<void>;
    }
    ```

    **In packages/database/src/repositories/drizzle-repositories.ts:**

    Add DrizzleOrgSubscriptionRepository implementing IOrgSubscriptionRepository:
    - findByTenantId: SELECT WHERE tenantId = ?
    - findByStripeCustomerId: SELECT WHERE stripeCustomerId = ? (returns first match)
    - upsert: INSERT ON CONFLICT (tenantId) DO UPDATE SET tier, seatLimit, stripeCustomerId, stripeSubscriptionId, trialEndsAt, currentPeriodEnds, updatedAt
    - insertIfNotExists: INSERT ON CONFLICT (tenantId) DO NOTHING, return result.length > 0 (true if inserted, false if already existed). Used by TrialService for race-safe trial activation.
    - updateTierByTenantId: UPDATE SET tier, updatedAt WHERE tenantId = ?
    - updateFromWebhook: UPDATE with partial data spread + updatedAt WHERE tenantId = ?

    Add DrizzleStripeWebhookEventRepository implementing IStripeWebhookEventRepository:
    - markProcessing: Try INSERT with unique event ID. If unique violation (error code 23505), return false (already processed). Otherwise return true.
    - markCompleted: UPDATE SET status = "completed", completedAt = now()
    - markFailed: UPDATE SET status = "failed", errorMessage

    Generate Drizzle migrations using `pnpm --filter @qpp/database db:generate` (which runs drizzle-kit generate). If drizzle-kit TUI blocks, use `drizzle-kit generate --custom` for the RLS-related parts and standard generate for DDL.

    Note: Do NOT remove subscriptionTier or seatLimit from the tenants table in this plan. Per research pitfall #4, columns are removed only after the refactored code is verified. That will be a future cleanup task.
  </action>
  <verify>
    - `pnpm typecheck` passes across all packages
    - Migration SQL files exist in packages/database/drizzle/
    - `pnpm db:migrate` applies cleanly (run against local dev DB)
    - New types (OrgSubscription, StripeWebhookEvent) are importable from @qpp/database
  </verify>
  <done>
    org_subscriptions and stripe_webhook_events tables defined in schema, interfaces exported (including findByStripeCustomerId and insertIfNotExists), Drizzle repository implementations created, migration generated and applied.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Stripe env vars and extend shared-types with trial state</name>
  <files>
    packages/backend-shared/src/config/env.schema.ts
    packages/shared-types/src/features.ts
  </files>
  <action>
    **In packages/backend-shared/src/config/env.schema.ts:**

    Add a new `stripeSchema` capability schema:
    ```typescript
    export const stripeSchema = z.object({
      STRIPE_SECRET_KEY: z.string().startsWith('sk_').optional(),
      STRIPE_WEBHOOK_SECRET: z.string().startsWith('whsec_').optional(),
    });
    ```

    Make both fields optional so existing dev environments work without Stripe keys configured (same pattern as observabilitySchema). When the BillingModule initializes, it will throw at runtime if keys are missing in production.

    Merge stripeSchema into apiEnvSchema:
    ```typescript
    export const apiEnvSchema = infrastructureSchema
      .merge(mceAuthSchema)
      .merge(mceJwtSchema)
      .merge(sessionSchema)
      .merge(observabilitySchema)
      .merge(stripeSchema)
      .extend({ PORT: z.coerce.number().default(3000) })
      .superRefine(...)
      ...
    ```

    Update the existing env schema unit tests to account for the new optional fields.

    **In packages/shared-types/src/features.ts:**

    Add TrialStateSchema:
    ```typescript
    export const TrialStateSchema = z.object({
      active: z.boolean(),
      daysRemaining: z.number().int().nullable(),
      endsAt: z.string().datetime().nullable(),
    });
    export type TrialState = z.infer<typeof TrialStateSchema>;
    ```

    Extend TenantFeaturesResponseSchema to include trial:
    ```typescript
    export const TenantFeaturesResponseSchema = z.object({
      tier: SubscriptionTierSchema,
      features: TenantFeaturesSchema,
      trial: TrialStateSchema.nullable(),
    });
    ```

    Update TenantFeaturesResponse type to reflect the new shape. This is a backward-compatible addition (trial is nullable, existing consumers that don't use it are unaffected).

    Add subscription audit event types constant for use by the audit system:
    ```typescript
    export const SUBSCRIPTION_AUDIT_EVENTS = [
      "subscription.trial_activated",
      "subscription.trial_expired",
      "subscription.created",
      "subscription.updated",
      "subscription.canceled",
      "subscription.payment_failed",
    ] as const;
    ```

    Create a SQL data migration script that populates org_subscriptions from existing tenants.
    Place this as migration 0033 (after 0031 for org_subscriptions DDL and 0032 for stripe_webhook_events DDL):
    ```sql
    INSERT INTO org_subscriptions (tenant_id, tier, seat_limit, created_at, updated_at)
    SELECT id, subscription_tier, seat_limit, installed_at, NOW()
    FROM tenants
    WHERE NOT EXISTS (
      SELECT 1 FROM org_subscriptions WHERE org_subscriptions.tenant_id = tenants.id
    );
    ```
    Use `drizzle-kit generate --custom` for this migration entry since it's a data migration, not a DDL change.
  </action>
  <verify>
    - `pnpm typecheck` passes across all packages (shared-types changes propagate)
    - `pnpm test` passes (env schema tests updated)
    - `pnpm lint` passes
    - TenantFeaturesResponse type includes `trial: TrialState | null`
    - STRIPE_SECRET_KEY and STRIPE_WEBHOOK_SECRET are recognized by env validation (but optional)
    - Data migration is numbered 0033 (after 0031 and 0032)
  </verify>
  <done>
    Stripe env vars validated at startup (optional), shared-types extended with TrialStateSchema and updated TenantFeaturesResponse, data migration script (0033) creates org_subscriptions rows from existing tenants.
  </done>
</task>

</tasks>

<verification>
- `pnpm typecheck` passes across all workspaces
- `pnpm test` passes across all workspaces
- `pnpm lint` passes
- `pnpm db:migrate` applies cleanly
- org_subscriptions table has rows matching existing tenants after migration
- New types importable: `import { OrgSubscription, IOrgSubscriptionRepository } from '@qpp/database'`
- New schemas importable: `import { TrialStateSchema } from '@qpp/shared-types'`
</verification>

<success_criteria>
- org_subscriptions and stripe_webhook_events tables exist in DB
- Repository interfaces and implementations are complete and tested
- IOrgSubscriptionRepository includes findByStripeCustomerId and insertIfNotExists methods
- Stripe env vars are part of API env validation (optional)
- TenantFeaturesResponse includes trial state
- Data migration (0033) populates org_subscriptions from existing tenants
- All existing tests continue to pass
</success_criteria>

<output>
After completion, create `.planning/phases/14-monetization/14-01-SUMMARY.md`
</output>
