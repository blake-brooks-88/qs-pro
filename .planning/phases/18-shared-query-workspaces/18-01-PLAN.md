---
phase: 18-shared-query-workspaces
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/database/src/schema.ts
  - packages/database/drizzle/0029_shared_query_workspaces.sql
  - packages/shared-types/src/features.ts
  - packages/shared-types/src/folders.ts
  - packages/shared-types/src/saved-queries.ts
  - packages/shared-types/src/errors/error-codes.ts
  - packages/shared-types/src/errors/error-messages.ts
  - packages/backend-shared/src/common/errors/error-policy.ts
autonomous: true

must_haves:
  truths:
    - "folders table has a visibility column with 'personal' as default"
    - "RLS policy allows users to see their own personal folders AND all shared folders in their BU"
    - "RLS WITH CHECK allows any BU user to mutate shared folders/queries"
    - "teamCollaboration feature key exists and is gated to Enterprise tier only"
    - "Shared types include visibility field in folder schemas"
    - "saved_queries has updated_by_user_id column for stale detection attribution"
    - "SavedQueryResponseSchema includes latestVersionHash for stale detection on load"
    - "STALE_CONTENT error code exists in shared-types and maps to HTTP 409"
  artifacts:
    - path: "packages/database/drizzle/0029_shared_query_workspaces.sql"
      provides: "Migration adding visibility column, updated_by_user_id, and conditional RLS"
      contains: "visibility"
    - path: "packages/database/src/schema.ts"
      provides: "Drizzle schema with visibility column on folders, updated_by_user_id on saved_queries"
      contains: "visibility"
    - path: "packages/shared-types/src/features.ts"
      provides: "teamCollaboration feature key in FeatureKeySchema and TIER_FEATURES"
      contains: "teamCollaboration"
    - path: "packages/shared-types/src/folders.ts"
      provides: "FolderVisibilitySchema and updated folder response/request types"
      contains: "FolderVisibilitySchema"
    - path: "packages/shared-types/src/saved-queries.ts"
      provides: "Updated saved query schemas with updatedByUserName, expectedHash, and latestVersionHash"
      contains: "latestVersionHash"
    - path: "packages/shared-types/src/errors/error-codes.ts"
      provides: "STALE_CONTENT error code in ErrorCode object"
      contains: "STALE_CONTENT"
    - path: "packages/backend-shared/src/common/errors/error-policy.ts"
      provides: "STALE_CONTENT mapped to HTTP 409 and added to TERMINAL_CODES"
      contains: "STALE_CONTENT"
  key_links:
    - from: "packages/database/src/schema.ts"
      to: "packages/database/drizzle/0029_shared_query_workspaces.sql"
      via: "Drizzle schema must match migration DDL"
      pattern: "visibility.*varchar"
    - from: "packages/shared-types/src/features.ts"
      to: "TIER_FEATURES.enterprise"
      via: "teamCollaboration in enterprise tier array"
      pattern: "teamCollaboration"
    - from: "packages/shared-types/src/errors/error-codes.ts"
      to: "packages/backend-shared/src/common/errors/error-policy.ts"
      via: "Error code defined in shared-types, HTTP mapping in backend-shared"
      pattern: "STALE_CONTENT"
---

<objective>
Add database foundation for shared query workspaces: visibility column on folders, conditional RLS policy, teamCollaboration feature key, shared-types updates, and STALE_CONTENT error code infrastructure.

Purpose: This is the foundational layer — all subsequent plans depend on the visibility column, the RLS policy, the feature key, and the error code existing.
Output: Migration file, updated Drizzle schema, updated shared-types for folders/saved-queries/features/errors, and backend-shared error policy update.
</objective>

<execution_context>
@/home/blakebrooks-88/.claude/get-shit-done/workflows/execute-plan.md
@/home/blakebrooks-88/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-shared-query-workspaces/18-RESEARCH.md
@.planning/phases/18-shared-query-workspaces/18-CONTEXT.md
@packages/database/src/schema.ts
@packages/database/drizzle/0011_rls_folders_saved_queries.sql
@packages/database/drizzle/0023_rls_broadened_with_check.sql
@packages/shared-types/src/features.ts
@packages/shared-types/src/folders.ts
@packages/shared-types/src/saved-queries.ts
@packages/shared-types/src/errors/error-codes.ts
@packages/shared-types/src/errors/error-messages.ts
@packages/backend-shared/src/common/errors/error-policy.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Database migration and Drizzle schema for shared workspaces</name>
  <files>
    packages/database/src/schema.ts
    packages/database/drizzle/0029_shared_query_workspaces.sql
  </files>
  <action>
**1. Update Drizzle schema (`packages/database/src/schema.ts`):**

Add `visibility` column to the `folders` table definition:
```typescript
visibility: varchar("visibility")
  .$type<"personal" | "shared">()
  .default("personal")
  .notNull(),
```
Place it after `name` and before `createdAt`. Also add a `visibilityIdx` to the table's index definitions:
```typescript
visibilityIdx: index("folders_visibility_idx").on(t.visibility),
```

Add `updatedByUserId` column to the `savedQueries` table definition:
```typescript
updatedByUserId: uuid("updated_by_user_id").references(() => users.id),
```
Place it after `updatedAt`.

**2. Create custom migration (`packages/database/drizzle/0029_shared_query_workspaces.sql`):**

Generate a custom migration entry first:
```bash
cd packages/database && npx drizzle-kit generate --custom --name=shared_query_workspaces
```

Then write the migration SQL:

```sql
-- Add visibility column to folders (default: personal)
ALTER TABLE "folders" ADD COLUMN "visibility" VARCHAR NOT NULL DEFAULT 'personal';

-- Add updated_by_user_id to saved_queries for stale detection attribution
ALTER TABLE "saved_queries" ADD COLUMN "updated_by_user_id" UUID REFERENCES "users"("id");

-- Index for efficient visibility filtering
CREATE INDEX "folders_visibility_idx" ON "folders" ("visibility");

-- Update folders RLS: personal folders = user-scoped, shared folders = BU-scoped
-- This replaces the original "folders_user_isolation" policy from migration 0011
DROP POLICY IF EXISTS "folders_user_isolation" ON "folders";
CREATE POLICY "folders_visibility_policy"
  ON "folders"
  USING (
    tenant_id::text = current_setting('app.tenant_id', true)
    AND mid = current_setting('app.mid', true)
    AND (
      visibility = 'shared'
      OR user_id::text = current_setting('app.user_id', true)
    )
  )
  WITH CHECK (
    tenant_id::text = current_setting('app.tenant_id', true)
    AND mid = current_setting('app.mid', true)
    AND (
      visibility = 'shared'
      OR user_id::text = current_setting('app.user_id', true)
    )
  );
```

Key RLS design:
- `USING`: Users see their OWN personal folders PLUS ALL shared folders in the BU (tenant+mid)
- `WITH CHECK`: Users can INSERT/UPDATE their own personal folders OR any shared folder. The `visibility = 'shared'` condition in WITH CHECK allows any BU user to mutate shared folder rows (BU-owned per locked decision).
- The `saved_queries` RLS is already broadened to `tenant_id + mid` (migration 0023), so shared queries within shared folders are already visible BU-wide. No saved_queries RLS change needed.

**Important:** Use `drizzle-kit generate --custom` to get a proper journal entry. Do NOT manually create the SQL file without the journal entry.
  </action>
  <verify>
Run `pnpm db:generate` to verify no drift between schema and migrations. Run `pnpm --filter @qpp/database build` to verify the schema compiles. Check that the migration file exists and has the correct SQL.
  </verify>
  <done>
- `folders` table in Drizzle schema has `visibility` column typed as `"personal" | "shared"` with default `"personal"`
- `savedQueries` table has `updatedByUserId` column referencing `users.id`
- Migration 0029 adds visibility column, updated_by_user_id column, visibility index, and conditional RLS policy
- RLS policy allows seeing personal folders (own) + shared folders (BU-wide)
- RLS WITH CHECK allows mutating own personal folders + any shared folder
- Database package builds cleanly
  </done>
</task>

<task type="auto">
  <name>Task 2: Shared-types updates for features, folders, and saved-queries</name>
  <files>
    packages/shared-types/src/features.ts
    packages/shared-types/src/folders.ts
    packages/shared-types/src/saved-queries.ts
  </files>
  <action>
**1. Add `teamCollaboration` feature key (`packages/shared-types/src/features.ts`):**

Add `"teamCollaboration"` to the `FeatureKeySchema` enum array (after `"versionHistory"`).

Add `"teamCollaboration"` to the `enterprise` array in `TIER_FEATURES`. Do NOT add it to `free` or `pro` — this is Enterprise-only per locked decision.

**2. Update folder schemas (`packages/shared-types/src/folders.ts`):**

Add `FolderVisibilitySchema`:
```typescript
export const FolderVisibilitySchema = z.enum(['personal', 'shared']);
export type FolderVisibility = z.infer<typeof FolderVisibilitySchema>;
```

Update `CreateFolderSchema` to include optional visibility:
```typescript
export const CreateFolderSchema = z.object({
  name: z.string().min(1).max(255),
  parentId: z.string().uuid().nullable().optional(),
  visibility: FolderVisibilitySchema.optional().default('personal'),
});
```

Update `UpdateFolderSchema` to include optional visibility:
```typescript
export const UpdateFolderSchema = z.object({
  name: z.string().min(1).max(255).optional(),
  parentId: z.string().uuid().nullable().optional(),
  visibility: FolderVisibilitySchema.optional(),
});
```

Update `FolderResponseSchema` to include visibility, creatorName, and creatorId:
```typescript
export const FolderResponseSchema = z.object({
  id: z.string().uuid(),
  name: z.string(),
  parentId: z.string().uuid().nullable(),
  visibility: FolderVisibilitySchema,
  userId: z.string().uuid(),
  creatorName: z.string().nullable().optional(),
  createdAt: z.string().datetime(),
  updatedAt: z.string().datetime(),
});
```

Export new types.

**3. Update saved-query schemas (`packages/shared-types/src/saved-queries.ts`):**

Add `expectedHash` to `UpdateSavedQuerySchema` for stale detection:
```typescript
export const UpdateSavedQuerySchema = z.object({
  name: z.string().min(1).max(255).optional(),
  sqlText: z.string().min(1).max(100000).optional(),
  folderId: z.string().uuid().nullable().optional(),
  expectedHash: z.string().optional(),
});
```

Add `latestVersionHash` to `SavedQueryResponseSchema` (the full detail response used when opening a query):
```typescript
latestVersionHash: z.string().nullable().optional(),
```
This field is critical for stale detection. The backend `findById` method will compute this from the latest `query_versions` row and include it in the response. The frontend captures it via `useStaleDetection.trackOpened()` when a query is loaded.

Add `updatedByUserName` to `SavedQueryResponseSchema`:
```typescript
updatedByUserName: z.string().nullable().optional(),
```

Add `updatedByUserName` and `updatedAt` to `SavedQueryListItemSchema` (updatedAt already exists, add updatedByUserName):
```typescript
updatedByUserName: z.string().nullable().optional(),
```

**Important:** Keep all existing fields intact. Only ADD new fields. Ensure all existing types continue to work.
  </action>
  <verify>
Run `pnpm --filter @qpp/shared-types build` and `pnpm --filter @qpp/shared-types test` to verify compilation and tests pass. Run `pnpm typecheck` to verify no downstream type errors from the schema changes.
  </verify>
  <done>
- `teamCollaboration` exists in `FeatureKeySchema` enum
- `teamCollaboration` is in `TIER_FEATURES.enterprise` but NOT in `free` or `pro`
- `FolderVisibilitySchema` exported with `'personal' | 'shared'` values
- `CreateFolderSchema` accepts optional `visibility` field (defaults to `'personal'`)
- `FolderResponseSchema` includes `visibility`, `userId`, and optional `creatorName`
- `UpdateSavedQuerySchema` includes optional `expectedHash` for stale detection
- `SavedQueryResponseSchema` includes `latestVersionHash` (nullable, optional) for stale detection on load
- `SavedQueryResponseSchema` includes optional `updatedByUserName`
- `SavedQueryListItemSchema` includes optional `updatedByUserName`
- All shared-types tests pass, all downstream packages typecheck clean
  </done>
</task>

<task type="auto">
  <name>Task 3: STALE_CONTENT error code infrastructure</name>
  <files>
    packages/shared-types/src/errors/error-codes.ts
    packages/shared-types/src/errors/error-messages.ts
    packages/backend-shared/src/common/errors/error-policy.ts
  </files>
  <action>
The error code system spans three files. All three MUST be updated:

**1. `packages/shared-types/src/errors/error-codes.ts`** — Add to the `ErrorCode` object in the "Business Logic" section:
```typescript
STALE_CONTENT: "STALE_CONTENT",
```

**2. `packages/shared-types/src/errors/error-messages.ts`** — Add client-facing message:
```typescript
[ErrorCode.STALE_CONTENT]: "This content was modified by another user. Please reload and try again.",
```

**3. `packages/backend-shared/src/common/errors/error-policy.ts`** — Three changes:
  - Add `ErrorCode.STALE_CONTENT` to the `TERMINAL_CODES` set (stale content won't resolve with retry — user must decide to overwrite or reload)
  - Add a case in `getHttpStatus()` for STALE_CONTENT mapping to 409:
```typescript
case ErrorCode.STALE_CONTENT:
  return 409;
```
  - Add entry in `getErrorTitle()`:
```typescript
[ErrorCode.STALE_CONTENT]: "Stale Content",
```
  </action>
  <verify>
Run `pnpm --filter @qpp/shared-types build` to verify error-codes compile. Run `pnpm --filter @qpp/backend-shared build` to verify error-policy compiles. Verify `STALE_CONTENT` exists in `error-codes.ts` and maps to 409 in `error-policy.ts`.
  </verify>
  <done>
- `STALE_CONTENT` error code added to `packages/shared-types/src/errors/error-codes.ts`
- `STALE_CONTENT` message added to `packages/shared-types/src/errors/error-messages.ts`
- `STALE_CONTENT` added to TERMINAL_CODES, mapped to 409, and titled in `packages/backend-shared/src/common/errors/error-policy.ts`
- Both packages build cleanly
  </done>
</task>

</tasks>

<verification>
1. `pnpm --filter @qpp/database build` passes (schema compiles)
2. `pnpm --filter @qpp/shared-types build && pnpm --filter @qpp/shared-types test` passes
3. `pnpm --filter @qpp/backend-shared build` passes
4. `pnpm typecheck` passes across all packages (no downstream type breaks)
5. Migration file `0029_shared_query_workspaces.sql` exists with correct DDL
6. `teamCollaboration` appears only in Enterprise tier features
7. `SavedQueryResponseSchema` includes `latestVersionHash` field
8. `STALE_CONTENT` error code exists and maps to HTTP 409
</verification>

<success_criteria>
- Database schema has `visibility` column on folders with conditional RLS
- `teamCollaboration` feature key is Enterprise-only
- Shared-types reflect new fields for folders (visibility, creatorName) and saved-queries (expectedHash, updatedByUserName, latestVersionHash)
- STALE_CONTENT error code defined across shared-types and backend-shared
- All packages build and typecheck cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/18-shared-query-workspaces/18-01-SUMMARY.md`
</output>
