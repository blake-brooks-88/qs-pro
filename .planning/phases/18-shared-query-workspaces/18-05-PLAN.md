---
phase: 18-shared-query-workspaces
plan: 05
type: execute
wave: 5
depends_on: ["18-03", "18-04"]
files_modified:
  - apps/api/src/folders/__tests__/folders-shared.integration.test.ts
  - apps/api/src/saved-queries/__tests__/saved-queries-stale.integration.test.ts
  - apps/api/src/query-activities/__tests__/query-activities-tier-gating.integration.test.ts
  - apps/web/src/features/editor-workspace/components/__tests__/SharedQuerySection.test.tsx
  - apps/web/src/features/editor-workspace/components/__tests__/StaleWarningDialog.test.tsx
  - apps/web/src/features/editor-workspace/components/__tests__/ShareConfirmationDialog.test.tsx
  - apps/web/src/features/editor-workspace/hooks/__tests__/use-stale-detection.test.ts
autonomous: true

must_haves:
  truths:
    - "Backend tests verify shared folder CRUD with teamCollaboration feature gating"
    - "Backend tests verify stale detection returns 409 on hash mismatch"
    - "Backend tests verify Pro-tier POST /query-activities/link/:savedQueryId returns 403"
    - "Backend tests verify Pro-tier POST /query-activities/publish/:savedQueryId returns 403"
    - "Backend tests verify Enterprise-tier link/publish/drift/blast endpoints succeed"
    - "Frontend tests verify two-section sidebar rendering"
    - "Frontend tests verify stale warning dialog behavior"
    - "Frontend tests verify link button hidden for personal queries"
  artifacts:
    - path: "apps/api/src/folders/__tests__/folders-shared.integration.test.ts"
      provides: "Integration tests for shared folder creation, feature gating, RLS visibility"
      min_lines: 80
    - path: "apps/api/src/saved-queries/__tests__/saved-queries-stale.integration.test.ts"
      provides: "Integration tests for stale detection 409 response"
      min_lines: 50
    - path: "apps/api/src/query-activities/__tests__/query-activities-tier-gating.integration.test.ts"
      provides: "Integration tests for Enterprise re-gating of link/publish/drift/blast"
      min_lines: 60
    - path: "apps/web/src/features/editor-workspace/components/__tests__/SharedQuerySection.test.tsx"
      provides: "Component tests for Enterprise badge, locked teaser, shared tree rendering"
      min_lines: 60
    - path: "apps/web/src/features/editor-workspace/components/__tests__/StaleWarningDialog.test.tsx"
      provides: "Component tests for stale warning dialog buttons and behavior"
      min_lines: 40
  key_links:
    - from: "apps/api/src/folders/__tests__/folders-shared.integration.test.ts"
      to: "apps/api/src/folders/folders.service.ts"
      via: "Tests exercise shared folder service methods"
      pattern: "teamCollaboration|visibility.*shared"
    - from: "apps/api/src/query-activities/__tests__/query-activities-tier-gating.integration.test.ts"
      to: "apps/api/src/query-activities/query-activities.controller.ts"
      via: "Tests verify endpoint-level tier gating for link/publish/drift/blast"
      pattern: "teamCollaboration|FEATURE_NOT_ENABLED"
    - from: "apps/web/src/features/editor-workspace/components/__tests__/SharedQuerySection.test.tsx"
      to: "apps/web/src/features/editor-workspace/components/SharedQuerySection.tsx"
      via: "Tests verify feature gating and rendering"
      pattern: "SharedQuerySection|teamCollaboration"
---

<objective>
Write comprehensive tests for all Phase 18 behavior: backend integration tests for shared folder CRUD, stale detection, and Enterprise tier-gating of link/publish/drift/blast; frontend component tests for the two-section sidebar, stale warning dialog, and share confirmation dialog.

Purpose: Verify all locked decisions are correctly implemented and prevent regressions.
Output: Test files for backend and frontend Phase 18 features.
</objective>

<execution_context>
@/home/blakebrooks-88/.claude/get-shit-done/workflows/execute-plan.md
@/home/blakebrooks-88/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-shared-query-workspaces/18-RESEARCH.md
@.planning/phases/18-shared-query-workspaces/18-CONTEXT.md
@.planning/phases/18-shared-query-workspaces/18-01-SUMMARY.md
@.planning/phases/18-shared-query-workspaces/18-02-SUMMARY.md
@.planning/phases/18-shared-query-workspaces/18-03-SUMMARY.md
@.planning/phases/18-shared-query-workspaces/18-04-SUMMARY.md
@apps/api/src/folders/__tests__/folders.integration.test.ts
@apps/api/src/query-activities/__tests__/query-activities.controller.unit.test.ts
@apps/web/src/features/editor-workspace/components/__tests__/
@apps/web/src/test/mocks/handlers.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Backend integration tests for shared folders, stale detection, and tier gating</name>
  <files>
    apps/api/src/folders/__tests__/folders-shared.integration.test.ts
    apps/api/src/saved-queries/__tests__/saved-queries-stale.integration.test.ts
    apps/api/src/query-activities/__tests__/query-activities-tier-gating.integration.test.ts
  </files>
  <action>
**1. Create `folders-shared.integration.test.ts`:**

Follow the existing `folders.integration.test.ts` pattern. Use the established test infrastructure: Fastify app setup with NestJS, real database with RLS helpers, test factories from `@qpp/test-utils`.

Test cases:

**Feature gating:**
- `POST /folders` with `visibility: 'shared'` returns FEATURE_NOT_ENABLED for free-tier tenant
- `POST /folders` with `visibility: 'shared'` returns FEATURE_NOT_ENABLED for pro-tier tenant
- `POST /folders` with `visibility: 'shared'` succeeds for enterprise-tier tenant
- `POST /folders/:id/share` returns FEATURE_NOT_ENABLED for pro-tier tenant
- `POST /folders/:id/share` succeeds for enterprise-tier tenant

**RLS visibility:**
- User A creates a personal folder — User B in same BU cannot see it via `GET /folders`
- User A creates a shared folder — User B in same BU CAN see it via `GET /folders`
- User A creates a personal folder — User A sees it; User B in DIFFERENT BU cannot see it
- Shared folder visible to all BU users regardless of creator

**Shared folder CRUD:**
- Enterprise User A creates shared folder — User B can rename it (BU-owned)
- Enterprise User A creates shared folder — User B can delete it (if empty, BU-owned per locked decision)
- Only folder creator can share a personal folder (POST /:id/share)
- Shared folder response includes `creatorName` from users table join

**Shared -> Personal blocked:**
- `PATCH /folders/:id` with `visibility: 'personal'` on a shared folder is rejected (or simply ignored — decide based on implementation)

**2. Create `saved-queries-stale.integration.test.ts`:**

Test cases:

**Stale detection:**
- `PATCH /saved-queries/:id` with matching `expectedHash` succeeds (no conflict)
- `PATCH /saved-queries/:id` with mismatched `expectedHash` returns 409 STALE_CONTENT
- `PATCH /saved-queries/:id` without `expectedHash` succeeds (backwards compat, personal queries)
- 409 response includes `conflictingUserId` or `conflictingUserName` in error metadata

**updatedByUserId tracking:**
- After save, `updatedByUserId` is set to the saving user's ID
- `GET /saved-queries/:id` response includes `updatedByUserName`

**latestVersionHash:**
- `GET /saved-queries/:id` response includes `latestVersionHash` from latest query_versions row
- After saving new SQL, `latestVersionHash` changes to the new hash

**3. Create `query-activities-tier-gating.integration.test.ts`:**

This file tests the re-gating of link/publish/drift/blast from Pro to Enterprise. These are endpoint-level tests verifying the controller's `requireTeamCollabFeature()` guard.

Test cases:

**Pro-tier (deployToAutomation=true, teamCollaboration=false) — link/publish/drift/blast blocked:**
- `POST /query-activities/link/:savedQueryId` returns 403 FEATURE_NOT_ENABLED for Pro-tier tenant
- `DELETE /query-activities/link/:savedQueryId` (unlink) returns 403 FEATURE_NOT_ENABLED for Pro-tier tenant
- `POST /query-activities/publish/:savedQueryId` returns 403 FEATURE_NOT_ENABLED for Pro-tier tenant
- `GET /query-activities/drift/:savedQueryId` returns 403 FEATURE_NOT_ENABLED for Pro-tier tenant
- `GET /query-activities/blast-radius/:savedQueryId` returns 403 FEATURE_NOT_ENABLED for Pro-tier tenant

**Pro-tier — deploy (create) still works:**
- `POST /query-activities` succeeds for Pro-tier tenant (fire-and-forget, no link)
- `GET /query-activities` succeeds for Pro-tier tenant

**Enterprise-tier (teamCollaboration=true) — all endpoints work:**
- `POST /query-activities/link/:savedQueryId` succeeds for Enterprise-tier tenant
- `POST /query-activities/publish/:savedQueryId` succeeds for Enterprise-tier tenant
- `GET /query-activities/drift/:savedQueryId` succeeds for Enterprise-tier tenant
- `GET /query-activities/blast-radius/:savedQueryId` succeeds for Enterprise-tier tenant

Follow Arrange-Act-Assert pattern. Use behavioral assertions (test response body, not mock calls). Use existing RLS test helpers (`withRlsContext`, etc.).
  </action>
  <verify>
Run `pnpm --filter api test` to verify all tests pass. Verify at least 20 test cases across all three files. Check that tests cover the locked decisions: feature gating, RLS visibility, stale detection, Enterprise tier-gating of link/publish/drift/blast.
  </verify>
  <done>
- `folders-shared.integration.test.ts` has 10+ test cases covering feature gating, RLS, CRUD, share
- `saved-queries-stale.integration.test.ts` has 7+ test cases covering hash comparison, 409, updatedByUserId, latestVersionHash
- `query-activities-tier-gating.integration.test.ts` has 10+ test cases covering Pro blocked (link/publish/drift/blast), Pro allowed (create/list), Enterprise allowed (all)
- All backend tests pass
  </done>
</task>

<task type="auto">
  <name>Task 2: Frontend component and hook tests</name>
  <files>
    apps/web/src/features/editor-workspace/components/__tests__/SharedQuerySection.test.tsx
    apps/web/src/features/editor-workspace/components/__tests__/StaleWarningDialog.test.tsx
    apps/web/src/features/editor-workspace/components/__tests__/ShareConfirmationDialog.test.tsx
    apps/web/src/features/editor-workspace/hooks/__tests__/use-stale-detection.test.ts
  </files>
  <action>
**1. Create `SharedQuerySection.test.tsx`:**

Test cases:
- Renders Enterprise badge when `teamCollaboration` is disabled
- Renders upgrade popover when badge is clicked
- Renders locked teaser with upgrade CTA for non-Enterprise users
- Renders shared folder tree when `teamCollaboration` is enabled
- Shows creator attribution (creatorName + timestamp) on shared items
- Context menu includes "Duplicate to Personal" for shared queries
- Context menu does NOT include "Link to Query Activity" for personal queries (verify by rendering personal section)
- Context menu DOES include "Link to Query Activity" for shared queries
- Downgrade: shows shared content as read-only (no write actions in context menu)
- Downgrade: allows opening/viewing shared queries

Use MSW handlers to mock the `/api/features` endpoint with different tier configurations. Follow existing component test patterns (render, act, assert with Testing Library).

Update `apps/web/src/test/mocks/handlers.ts` to include `teamCollaboration: false` in the default features mock (free tier). Add a helper to override features for enterprise tests.

**2. Create `StaleWarningDialog.test.tsx`:**

Test cases:
- Renders dialog when `open=true`
- Shows conflicting user name in message
- Shows generic message when conflicting user name is null
- "Overwrite with Mine" button calls `onOverwrite`
- "Reload Their Changes" button calls `onReload`
- "Cancel" button calls `onCancel`
- Dialog closes on escape key (via onCancel)

**3. Create `ShareConfirmationDialog.test.tsx`:**

Test cases:
- Renders correct message for folder sharing: "Everyone in this BU will be able to view and edit all queries in..."
- Renders correct message for query sharing
- "Share" button calls `onConfirm`
- Cancel button calls `onCancel`
- Dialog shows item name in the title

**4. Create `use-stale-detection.test.ts`:**

Test cases:
- `trackOpened` stores the hash
- `openedHash` returns the stored hash
- `updateHash` replaces the stored hash
- Multiple calls to `trackOpened` update the hash (latest wins)
- Initial state has `openedHash` as null

Use `renderHook` from `@testing-library/react-hooks` or `@testing-library/react`.

**5. Update default MSW handlers:**

In `apps/web/src/test/mocks/handlers.ts`, add `teamCollaboration` to the features mock response:
```typescript
teamCollaboration: false, // Free tier default
```

This ensures existing tests don't break (they expect non-Enterprise behavior).
  </action>
  <verify>
Run `pnpm --filter @qpp/web test` to verify all tests pass. Verify at least 20 test cases across all test files. Check that MSW handlers mock includes `teamCollaboration`.
  </verify>
  <done>
- `SharedQuerySection.test.tsx` has 8+ test cases for feature gating, rendering, context menus, downgrade
- `StaleWarningDialog.test.tsx` has 6+ test cases for dialog rendering and button callbacks
- `ShareConfirmationDialog.test.tsx` has 4+ test cases for dialog content and callbacks
- `use-stale-detection.test.ts` has 4+ test cases for hook behavior
- Default MSW handlers include `teamCollaboration: false`
- All web tests pass
  </done>
</task>

</tasks>

<verification>
1. `pnpm --filter api test` passes (all backend tests)
2. `pnpm --filter @qpp/web test` passes (all frontend tests)
3. `pnpm test` passes (full monorepo)
4. At least 40 new test cases total across all files
5. Tests cover all locked decisions: feature gating, RLS, stale detection, link hiding, enhanced delete, Enterprise tier-gating of link/publish/drift/blast
</verification>

<success_criteria>
- Comprehensive test coverage for all Phase 18 features
- Backend integration tests verify real database behavior (not mocks)
- Tier-gating tests confirm Pro cannot link/publish/drift/blast (403), Enterprise can
- Frontend tests verify component rendering and user interactions
- No regressions in existing test suites
</success_criteria>

<output>
After completion, create `.planning/phases/18-shared-query-workspaces/18-05-SUMMARY.md`
</output>
