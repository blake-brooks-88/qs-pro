---
phase: 18-shared-query-workspaces
plan: 02
type: execute
wave: 2
depends_on: ["18-01"]
files_modified:
  - apps/api/src/folders/folders.service.ts
  - apps/api/src/folders/folders.controller.ts
  - apps/api/src/folders/folders.repository.ts
  - apps/api/src/folders/drizzle-folders.repository.ts
  - apps/api/src/folders/folders.module.ts
  - apps/api/src/saved-queries/saved-queries.service.ts
  - apps/api/src/saved-queries/saved-queries.controller.ts
  - apps/api/src/saved-queries/saved-queries.repository.ts
  - apps/api/src/query-activities/query-activities.controller.ts
  - packages/shared-types/src/errors/error-codes.ts
  - packages/shared-types/src/errors/error-messages.ts
  - packages/backend-shared/src/common/errors/error-policy.ts
autonomous: true

must_haves:
  truths:
    - "Enterprise users can create folders with visibility='shared'"
    - "Non-Enterprise users get FEATURE_NOT_ENABLED when attempting shared folder operations"
    - "Shared folder list returns creator name from users table join"
    - "Saving a shared query with a stale expectedHash returns 409 Conflict"
    - "saved_queries.updated_by_user_id is set on every update"
    - "linkQuery, unlinkQuery, publishQuery, checkDrift, and getBlastRadius require teamCollaboration (Enterprise), not just deployToAutomation (Pro)"
    - "GET /saved-queries/:id response includes latestVersionHash from the latest query_versions row"
  artifacts:
    - path: "apps/api/src/folders/folders.service.ts"
      provides: "Shared folder create/update with teamCollaboration feature check"
      contains: "teamCollaboration"
    - path: "apps/api/src/folders/folders.controller.ts"
      provides: "Updated toResponse with visibility and creatorName fields"
      contains: "visibility"
    - path: "apps/api/src/folders/drizzle-folders.repository.ts"
      provides: "findAll with user join for creator name, visibility-aware queries"
      contains: "creatorName"
    - path: "apps/api/src/saved-queries/saved-queries.service.ts"
      provides: "Stale detection via expectedHash comparison, updatedByUserId tracking, latestVersionHash in findById"
      contains: "expectedHash"
    - path: "apps/api/src/query-activities/query-activities.controller.ts"
      provides: "Re-gated link/publish/drift/blast endpoints requiring teamCollaboration"
      contains: "teamCollaboration"
    - path: "packages/shared-types/src/errors/error-codes.ts"
      provides: "STALE_CONTENT error code"
      contains: "STALE_CONTENT"
    - path: "packages/shared-types/src/errors/error-messages.ts"
      provides: "Client-facing message for STALE_CONTENT"
      contains: "STALE_CONTENT"
    - path: "packages/backend-shared/src/common/errors/error-policy.ts"
      provides: "STALE_CONTENT mapped to 409 and added to TERMINAL_CODES"
      contains: "STALE_CONTENT"
  key_links:
    - from: "apps/api/src/folders/folders.service.ts"
      to: "apps/api/src/features/features.service.ts"
      via: "getTenantFeatures for teamCollaboration check"
      pattern: "features\\.teamCollaboration"
    - from: "apps/api/src/saved-queries/saved-queries.service.ts"
      to: "query_versions table"
      via: "Hash comparison for stale detection"
      pattern: "expectedHash|sqlTextHash"
    - from: "apps/api/src/query-activities/query-activities.controller.ts"
      to: "apps/api/src/features/features.service.ts"
      via: "requireTeamCollabFeature for link/publish/drift/blast"
      pattern: "teamCollaboration"
---

<objective>
Add backend logic for shared folder operations, stale detection on shared query saves, re-gate link/publish/drift/blast endpoints from Pro to Enterprise, and wire latestVersionHash into the saved query detail response.

Purpose: Backend business logic that enforces sharing rules, stale detection, tier gating for collaboration features, and provides the hash needed for frontend stale detection.
Output: Updated folder service/controller/repository, saved-queries service/controller, query-activities controller, and error code additions.
</objective>

<execution_context>
@/home/blakebrooks-88/.claude/get-shit-done/workflows/execute-plan.md
@/home/blakebrooks-88/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-shared-query-workspaces/18-RESEARCH.md
@.planning/phases/18-shared-query-workspaces/18-CONTEXT.md
@.planning/phases/18-shared-query-workspaces/18-01-SUMMARY.md
@apps/api/src/folders/folders.service.ts
@apps/api/src/folders/folders.controller.ts
@apps/api/src/folders/folders.repository.ts
@apps/api/src/folders/drizzle-folders.repository.ts
@apps/api/src/folders/folders.module.ts
@apps/api/src/saved-queries/saved-queries.service.ts
@apps/api/src/saved-queries/saved-queries.controller.ts
@apps/api/src/saved-queries/saved-queries.repository.ts
@apps/api/src/query-activities/query-activities.controller.ts
@apps/api/src/features/features.service.ts
@packages/shared-types/src/errors/error-codes.ts
@packages/shared-types/src/errors/error-messages.ts
@packages/backend-shared/src/common/errors/error-policy.ts
@packages/backend-shared/src/database/rls-context.service.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Shared folder service, repository, and controller changes</name>
  <files>
    apps/api/src/folders/folders.service.ts
    apps/api/src/folders/folders.controller.ts
    apps/api/src/folders/folders.repository.ts
    apps/api/src/folders/drizzle-folders.repository.ts
    apps/api/src/folders/folders.module.ts
  </files>
  <action>
**1. Update `FoldersRepository` interface (`folders.repository.ts`):**

Update the `Folder` type to include `visibility` and a `creatorName` (nullable string, populated via JOIN). Update `create` params to accept `visibility`. Update `findAll` to return folders with `creatorName`. Add `findById` to return folder with `creatorName`.

```typescript
export interface Folder {
  id: string;
  tenantId: string;
  mid: string;
  userId: string;
  parentId: string | null;
  name: string;
  visibility: 'personal' | 'shared';
  creatorName: string | null;
  createdAt: Date;
  updatedAt: Date;
}
```

**2. Update `DrizzleFoldersRepository` (`drizzle-folders.repository.ts`):**

- `findAll()`: LEFT JOIN with `users` table to get `users.name AS creatorName`. Include `visibility` in select. Map result to include `creatorName`.
- `create()`: Accept `visibility` param (default `'personal'`). Write it to the `visibility` column.
- `update()`: Accept optional `visibility` param. Write it if present.
- `findById()`: LEFT JOIN with users table for creatorName.

**3. Update `FoldersService` (`folders.service.ts`):**

Inject `FeaturesService` (import from `../features/features.service`).

Add feature gate logic for shared folder operations:

- `create()`: If `dto.visibility === 'shared'`, call `this.featuresService.getTenantFeatures(tenantId)` and check `features.teamCollaboration`. Throw `AppError(ErrorCode.FEATURE_NOT_ENABLED)` if not enabled. When creating a shared folder, still use `runWithUserContext` — the new RLS WITH CHECK allows the creator to create shared folders since `visibility = 'shared'` satisfies the WITH CHECK condition.

- `update()`: If `dto.visibility` is being changed to `'shared'`, feature-check `teamCollaboration`. If changing TO `'shared'` and the user is NOT the folder owner, throw `AppError(ErrorCode.FORBIDDEN)` — only the creator can share a folder. If the folder is already shared and the update is a rename/move, allow any BU user (no owner check needed — BU-owned per locked decision). Use `runWithUserContext` for personal folder operations. For shared folder mutations by non-creators, the RLS WITH CHECK condition `visibility = 'shared'` handles this.

- `delete()`: For shared folders, show enhanced behavior. The existing `hasChildren` check remains. Any BU user can delete shared folders per locked decision (the RLS policy allows this via `visibility = 'shared'` in WITH CHECK). No special feature check on delete — if the folder is already shared, deleting is allowed regardless of current tier (avoids data-lock on downgrade).

- `findAll()`: After the new conditional RLS policy (Plan 01), `runWithUserContext` will automatically return personal folders (user_id match) PLUS shared folders (visibility='shared' match). No code change needed here.

- Add a `shareFolder()` method: Takes folderId, checks `teamCollaboration` feature, verifies the caller is the folder creator (only creator can share), then updates visibility to `'shared'`. This is used for the drag-to-shared confirmation flow.

- **No "unshare" (move shared to personal)**: Per locked decision, once shared, a query stays shared. Do NOT implement moving from shared to personal.

**4. Update `FoldersController` (`folders.controller.ts`):**

- Update `toResponse()` to include `visibility`, `userId`, and `creatorName` fields in the response.
- Add `POST :id/share` endpoint (guarded by SessionGuard + CsrfGuard + @Audited('folder.shared')) that calls `foldersService.shareFolder()`.
- Update `CreateFolderSchema` import to use the updated schema that includes `visibility`.

**5. Update `FoldersModule` (`folders.module.ts`):**

Import `FeaturesModule` if not already imported (needed for FeaturesService injection in FoldersService). Follow the pattern from AuditModule: `imports: [FeaturesModule]`.

**Important design notes:**
- `runWithUserContext` still works for shared folder reads because the new conditional RLS policy returns shared folders too (via `visibility = 'shared'` in USING clause).
- `runWithUserContext` works for shared folder writes because the new WITH CHECK includes `visibility = 'shared'` — any BU user can mutate shared rows.
- Do NOT use `runWithTenantContext` for shared folder operations. The conditional RLS policy handles everything via `runWithUserContext`.
  </action>
  <verify>
Run `pnpm --filter api test` to verify existing folder tests still pass. Run `pnpm typecheck` to verify type safety. Manually check that the FeaturesModule import is in FoldersModule.
  </verify>
  <done>
- `FoldersService` gates shared folder creation behind `teamCollaboration` feature check
- `shareFolder()` method exists for drag-to-shared flow, checks feature + creator ownership
- `FoldersController.toResponse()` returns `visibility`, `userId`, and `creatorName`
- `POST /folders/:id/share` endpoint exists with CsrfGuard and Audited decorator
- `DrizzleFoldersRepository.findAll()` joins users table for creatorName
- `FoldersModule` imports `FeaturesModule`
- All existing folder tests pass, typecheck clean
  </done>
</task>

<task type="auto">
  <name>Task 2: Stale detection, STALE_CONTENT error code, latestVersionHash response, and re-gate link/publish/drift/blast to Enterprise</name>
  <files>
    apps/api/src/saved-queries/saved-queries.service.ts
    apps/api/src/saved-queries/saved-queries.controller.ts
    apps/api/src/saved-queries/saved-queries.repository.ts
    apps/api/src/query-activities/query-activities.controller.ts
    packages/shared-types/src/errors/error-codes.ts
    packages/shared-types/src/errors/error-messages.ts
    packages/backend-shared/src/common/errors/error-policy.ts
  </files>
  <action>
**1. Add STALE_CONTENT error code (three files):**

The error code system spans three files. All three MUST be updated:

**a) `packages/shared-types/src/errors/error-codes.ts`** — Add to the `ErrorCode` object in the "Business Logic" section:
```typescript
STALE_CONTENT: "STALE_CONTENT",
```

**b) `packages/shared-types/src/errors/error-messages.ts`** — Add client-facing message:
```typescript
[ErrorCode.STALE_CONTENT]: "This content was modified by another user. Please reload and try again.",
```

**c) `packages/backend-shared/src/common/errors/error-policy.ts`** — Two changes:
  - Add `ErrorCode.STALE_CONTENT` to the `TERMINAL_CODES` set (stale content won't resolve with retry — user must decide to overwrite or reload)
  - Add a case in `getHttpStatus()` for STALE_CONTENT mapping to 409:
```typescript
case ErrorCode.STALE_CONTENT:
  return 409;
```
  - Add entry in `getErrorTitle()`:
```typescript
[ErrorCode.STALE_CONTENT]: "Stale Content",
```

**2. Update `SavedQueriesService` (`saved-queries.service.ts`):**

**Stale detection in `update()` method:**

Before performing the save, check for stale content when `dto.expectedHash` is provided:

```typescript
if (dto.sqlText && dto.expectedHash) {
  const latestVersion = await this.queryVersionsRepository.findLatestBySavedQueryId(id);
  if (latestVersion && latestVersion.sqlTextHash !== dto.expectedHash) {
    // Query was modified by someone else since the user opened it
    const savedQuery = await this.savedQueriesRepository.findById(id);
    throw new AppError(ErrorCode.STALE_CONTENT, undefined, {
      reason: 'Query was modified since you opened it',
      conflictingUserId: savedQuery?.updatedByUserId ?? null,
    });
  }
}
```

**Track `updatedByUserId` on every update:**

In the `update()` method, after the existing save logic, set `updatedByUserId` to the current user's ID. Pass it through to the repository update call:
```typescript
const query = await this.savedQueriesRepository.update(id, {
  ...updateParams,
  updatedByUserId: userId,
});
```

Update the `SavedQueriesRepository` interface and `DrizzleSavedQueriesRepository` to accept and write `updatedByUserId`.

**Wire `latestVersionHash` into findById response:**

In the `findById()` method (or wherever the detail response is built for `GET /saved-queries/:id`), fetch the latest version hash:
```typescript
const latestVersion = await this.queryVersionsRepository.findLatestBySavedQueryId(id);
const latestVersionHash = latestVersion?.sqlTextHash ?? null;
```
Include `latestVersionHash` in the returned response object. This is what the frontend captures via `useStaleDetection.trackOpened()` when a query is opened.

**Return `updatedByUserName` in responses:**

When returning saved query responses (findById, findAll, findAllListItems), JOIN with users table to get the name of the user who last updated. Add `updatedByUserName` to the response interface and map it accordingly.

**3. Update `SavedQueriesController` (`saved-queries.controller.ts`):**

Update the `toResponse()` and `toListItem()` methods to include `updatedByUserName` and `latestVersionHash` in the response.

**4. Re-gate link/publish/drift/blast to Enterprise (`query-activities.controller.ts`):**

The current `requireDeployFeature()` method checks `features.deployToAutomation`. For the link, unlink, publish, drift, and blast-radius endpoints, these must now ALSO require `teamCollaboration` (Enterprise tier).

Add a new private method `requireTeamCollabFeature()`:
```typescript
private async requireTeamCollabFeature(tenantId: string): Promise<void> {
  const { features } = await this.featuresService.getTenantFeatures(tenantId);
  if (!features.teamCollaboration) {
    throw new AppError(ErrorCode.FEATURE_NOT_ENABLED, undefined, {
      operation: 'teamCollaboration',
      reason: 'Linking, publishing, and drift detection require Enterprise subscription',
    });
  }
}
```

Update these endpoints to call `requireTeamCollabFeature()` INSTEAD OF (not in addition to) `requireDeployFeature()`:
- `linkQuery()` — replace `await this.requireDeployFeature(user.tenantId)` with `await this.requireTeamCollabFeature(user.tenantId)`
- `unlinkQuery()` — same replacement
- `publishQuery()` — same replacement
- `checkDrift()` — same replacement
- `getBlastRadius()` — same replacement

The `create()` and `findAll()` and `findOne()` endpoints keep using `requireDeployFeature()` — deploy (fire-and-forget QA creation) stays at Pro tier. Only the linking/publishing/drift/blast operations move to Enterprise.

This is the critical re-gating from the Roadmap tier model:
- Pro: deploy (fire-and-forget only, no persistent link)
- Enterprise: deploy + link + publish + drift + blast radius

Per the Roadmap: "Gates: shared folder CRUD, move to/from shared, linking, publishing, drift detection, blast radius" and "deployToAutomation stays Pro but becomes fire-and-forget only (no persistent link)"

**Important notes:**
- There is NO auto-link step in `QueryActivitiesService.create()`. The `create()` method returns `{ objectId, customerKey }` and the linking is a separate explicit user action via `POST /query-activities/link/:savedQueryId`. The current behavior is already fire-and-forget for create. The re-gating work is entirely about changing which endpoints check which feature key.
- `requireDeployFeature()` remains unchanged and continues to be used for `create()`, `findAll()`, and `findOne()`.
  </action>
  <verify>
Run `pnpm --filter api test` to verify all API tests pass. Run `pnpm typecheck` to verify type safety. Verify the STALE_CONTENT error code exists in `packages/shared-types/src/errors/error-codes.ts` and maps to 409 in `packages/backend-shared/src/common/errors/error-policy.ts`. Verify `query-activities.controller.ts` has `requireTeamCollabFeature` calls on linkQuery, unlinkQuery, publishQuery, checkDrift, and getBlastRadius.
  </verify>
  <done>
- `STALE_CONTENT` error code added to `packages/shared-types/src/errors/error-codes.ts`
- `STALE_CONTENT` message added to `packages/shared-types/src/errors/error-messages.ts`
- `STALE_CONTENT` added to TERMINAL_CODES, mapped to 409, and titled in `packages/backend-shared/src/common/errors/error-policy.ts`
- `SavedQueriesService.update()` checks `expectedHash` and throws `STALE_CONTENT` (409) on mismatch
- `updatedByUserId` is set on every save to the current user's ID
- `updatedByUserName` is returned in saved query responses (joined from users table)
- `latestVersionHash` is returned in `GET /saved-queries/:id` response from latest query_versions row
- `linkQuery`, `unlinkQuery`, `publishQuery`, `checkDrift`, and `getBlastRadius` require `teamCollaboration` (Enterprise) instead of `deployToAutomation` (Pro)
- `create()`, `findAll()`, and `findOne()` still use `requireDeployFeature()` (Pro tier)
- All API tests pass, typecheck clean
  </done>
</task>

</tasks>

<verification>
1. `pnpm --filter api test` passes (all existing + new behavior)
2. `pnpm typecheck` passes across all packages
3. Shared folder create with `visibility: 'shared'` returns 200 for Enterprise, FEATURE_NOT_ENABLED for Pro/Free
4. Save with stale `expectedHash` returns 409 Conflict
5. `GET /folders` returns `visibility`, `userId`, `creatorName` in response
6. `GET /saved-queries/:id` returns `latestVersionHash` in response
7. Pro-tier `POST /query-activities/link/:id` returns 403 FEATURE_NOT_ENABLED
8. Enterprise-tier `POST /query-activities/link/:id` succeeds
9. Pro-tier `POST /query-activities` (deploy) still succeeds (fire-and-forget)
</verification>

<success_criteria>
- Shared folder CRUD gated behind teamCollaboration (Enterprise only)
- Stale detection prevents concurrent save conflicts on shared queries
- Link/publish/drift/blast re-gated from Pro (deployToAutomation) to Enterprise (teamCollaboration)
- All responses include new fields (visibility, creatorName, updatedByUserName, latestVersionHash)
- STALE_CONTENT error code properly defined across all three error files
</success_criteria>

<output>
After completion, create `.planning/phases/18-shared-query-workspaces/18-02-SUMMARY.md`
</output>
