---
phase: 18-shared-query-workspaces
plan: 02
type: execute
wave: 2
depends_on: ["18-01"]
files_modified:
  - apps/api/src/folders/folders.service.ts
  - apps/api/src/folders/folders.controller.ts
  - apps/api/src/folders/folders.repository.ts
  - apps/api/src/folders/drizzle-folders.repository.ts
  - apps/api/src/folders/folders.module.ts
  - apps/api/src/saved-queries/saved-queries.service.ts
  - apps/api/src/saved-queries/saved-queries.controller.ts
  - apps/api/src/saved-queries/saved-queries.repository.ts
autonomous: true

must_haves:
  truths:
    - "Enterprise users can create folders with visibility='shared'"
    - "Non-Enterprise users get FEATURE_NOT_ENABLED when attempting shared folder operations"
    - "Shared folder list returns creator name from users table join"
    - "Saving a shared query with a stale expectedHash returns 409 Conflict"
    - "saved_queries.updated_by_user_id is set on every update"
    - "GET /saved-queries/:id response includes latestVersionHash from the latest query_versions row"
  artifacts:
    - path: "apps/api/src/folders/folders.service.ts"
      provides: "Shared folder create/update with teamCollaboration feature check"
      contains: "teamCollaboration"
    - path: "apps/api/src/folders/folders.controller.ts"
      provides: "Updated toResponse with visibility and creatorName fields"
      contains: "visibility"
    - path: "apps/api/src/folders/drizzle-folders.repository.ts"
      provides: "findAll with user join for creator name, visibility-aware queries"
      contains: "creatorName"
    - path: "apps/api/src/saved-queries/saved-queries.service.ts"
      provides: "Stale detection via expectedHash comparison, updatedByUserId tracking, latestVersionHash in findById"
      contains: "expectedHash"
  key_links:
    - from: "apps/api/src/folders/folders.service.ts"
      to: "apps/api/src/features/features.service.ts"
      via: "getTenantFeatures for teamCollaboration check"
      pattern: "features\\.teamCollaboration"
    - from: "apps/api/src/saved-queries/saved-queries.service.ts"
      to: "query_versions table"
      via: "Hash comparison for stale detection"
      pattern: "expectedHash|sqlTextHash"
---

<objective>
Add backend logic for shared folder operations, stale detection on shared query saves, and wire latestVersionHash into the saved query detail response.

Purpose: Backend business logic that enforces sharing rules, stale detection, and provides the hash needed for frontend stale detection. Query-activities endpoints are NOT modified — `deployToAutomation` continues to gate linking as it does today per user decision (no re-gating migration needed).
Output: Updated folder service/controller/repository and saved-queries service/controller/repository.
</objective>

<execution_context>
@/home/blakebrooks-88/.claude/get-shit-done/workflows/execute-plan.md
@/home/blakebrooks-88/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-shared-query-workspaces/18-RESEARCH.md
@.planning/phases/18-shared-query-workspaces/18-CONTEXT.md
@.planning/phases/18-shared-query-workspaces/18-01-SUMMARY.md
@apps/api/src/folders/folders.service.ts
@apps/api/src/folders/folders.controller.ts
@apps/api/src/folders/folders.repository.ts
@apps/api/src/folders/drizzle-folders.repository.ts
@apps/api/src/folders/folders.module.ts
@apps/api/src/saved-queries/saved-queries.service.ts
@apps/api/src/saved-queries/saved-queries.controller.ts
@apps/api/src/saved-queries/saved-queries.repository.ts
@apps/api/src/features/features.service.ts
@packages/backend-shared/src/database/rls-context.service.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Shared folder service, repository, and controller changes</name>
  <files>
    apps/api/src/folders/folders.service.ts
    apps/api/src/folders/folders.controller.ts
    apps/api/src/folders/folders.repository.ts
    apps/api/src/folders/drizzle-folders.repository.ts
    apps/api/src/folders/folders.module.ts
  </files>
  <action>
**1. Update `FoldersRepository` interface (`folders.repository.ts`):**

Update the `Folder` type to include `visibility` and a `creatorName` (nullable string, populated via JOIN). Update `create` params to accept `visibility`. Update `findAll` to return folders with `creatorName`. Add `findById` to return folder with `creatorName`.

```typescript
export interface Folder {
  id: string;
  tenantId: string;
  mid: string;
  userId: string;
  parentId: string | null;
  name: string;
  visibility: 'personal' | 'shared';
  creatorName: string | null;
  createdAt: Date;
  updatedAt: Date;
}
```

**2. Update `DrizzleFoldersRepository` (`drizzle-folders.repository.ts`):**

- `findAll()`: LEFT JOIN with `users` table to get `users.name AS creatorName`. Include `visibility` in select. Map result to include `creatorName`.
- `create()`: Accept `visibility` param (default `'personal'`). Write it to the `visibility` column.
- `update()`: Accept optional `visibility` param. Write it if present.
- `findById()`: LEFT JOIN with users table for creatorName.

**3. Update `FoldersService` (`folders.service.ts`):**

Inject `FeaturesService` (import from `../features/features.service`).

Add feature gate logic for shared folder operations:

- `create()`: If `dto.visibility === 'shared'`, call `this.featuresService.getTenantFeatures(tenantId)` and check `features.teamCollaboration`. Throw `AppError(ErrorCode.FEATURE_NOT_ENABLED)` if not enabled. When creating a shared folder, still use `runWithUserContext` — the new RLS WITH CHECK allows the creator to create shared folders since `visibility = 'shared'` satisfies the WITH CHECK condition.

- `update()`: If `dto.visibility` is being changed to `'shared'`, feature-check `teamCollaboration`. If changing TO `'shared'` and the user is NOT the folder owner, throw `AppError(ErrorCode.FORBIDDEN)` — only the creator can share a folder. If the folder is already shared and the update is a rename/move, allow any BU user (no owner check needed — BU-owned per locked decision). Use `runWithUserContext` for personal folder operations. For shared folder mutations by non-creators, the RLS WITH CHECK condition `visibility = 'shared'` handles this.

- `delete()`: For shared folders, show enhanced behavior. The existing `hasChildren` check remains. Any BU user can delete shared folders per locked decision (the RLS policy allows this via `visibility = 'shared'` in WITH CHECK). No special feature check on delete — if the folder is already shared, deleting is allowed regardless of current tier (avoids data-lock on downgrade).

- `findAll()`: After the new conditional RLS policy (Plan 01), `runWithUserContext` will automatically return personal folders (user_id match) PLUS shared folders (visibility='shared' match). No code change needed here.

- Add a `shareFolder()` method: Takes folderId, checks `teamCollaboration` feature, verifies the caller is the folder creator (only creator can share), then updates visibility to `'shared'`. This is used for the drag-to-shared confirmation flow.

- **No "unshare" (move shared to personal)**: Per locked decision, once shared, a query stays shared. Do NOT implement moving from shared to personal.

**4. Update `FoldersController` (`folders.controller.ts`):**

- Update `toResponse()` to include `visibility`, `userId`, and `creatorName` fields in the response.
- Add `POST :id/share` endpoint (guarded by SessionGuard + CsrfGuard + @Audited('folder.shared')) that calls `foldersService.shareFolder()`.
- Update `CreateFolderSchema` import to use the updated schema that includes `visibility`.

**5. Update `FoldersModule` (`folders.module.ts`):**

Import `FeaturesModule` if not already imported (needed for FeaturesService injection in FoldersService). Follow the pattern from AuditModule: `imports: [FeaturesModule]`.

**Important design notes:**
- `runWithUserContext` still works for shared folder reads because the new conditional RLS policy returns shared folders too (via `visibility = 'shared'` in USING clause).
- `runWithUserContext` works for shared folder writes because the new WITH CHECK includes `visibility = 'shared'` — any BU user can mutate shared rows.
- Do NOT use `runWithTenantContext` for shared folder operations. The conditional RLS policy handles everything via `runWithUserContext`.
  </action>
  <verify>
Run `pnpm --filter api test` to verify existing folder tests still pass. Run `pnpm typecheck` to verify type safety. Manually check that the FeaturesModule import is in FoldersModule.
  </verify>
  <done>
- `FoldersService` gates shared folder creation behind `teamCollaboration` feature check
- `shareFolder()` method exists for drag-to-shared flow, checks feature + creator ownership
- `FoldersController.toResponse()` returns `visibility`, `userId`, and `creatorName`
- `POST /folders/:id/share` endpoint exists with CsrfGuard and Audited decorator
- `DrizzleFoldersRepository.findAll()` joins users table for creatorName
- `FoldersModule` imports `FeaturesModule`
- All existing folder tests pass, typecheck clean
  </done>
</task>

<task type="auto">
  <name>Task 2: Stale detection, latestVersionHash response, and updatedByUserId tracking</name>
  <files>
    apps/api/src/saved-queries/saved-queries.service.ts
    apps/api/src/saved-queries/saved-queries.controller.ts
    apps/api/src/saved-queries/saved-queries.repository.ts
  </files>
  <action>
**1. Update `SavedQueriesService` (`saved-queries.service.ts`):**

**Stale detection in `update()` method:**

Before performing the save, check for stale content when `dto.expectedHash` is provided:

```typescript
if (dto.sqlText && dto.expectedHash) {
  const latestVersion = await this.queryVersionsRepository.findLatestBySavedQueryId(id);
  if (latestVersion && latestVersion.sqlTextHash !== dto.expectedHash) {
    // Query was modified by someone else since the user opened it
    const savedQuery = await this.savedQueriesRepository.findById(id);
    throw new AppError(ErrorCode.STALE_CONTENT, undefined, {
      reason: 'Query was modified since you opened it',
      conflictingUserId: savedQuery?.updatedByUserId ?? null,
    });
  }
}
```

**Track `updatedByUserId` on every update:**

In the `update()` method, after the existing save logic, set `updatedByUserId` to the current user's ID. Pass it through to the repository update call:
```typescript
const query = await this.savedQueriesRepository.update(id, {
  ...updateParams,
  updatedByUserId: userId,
});
```

Update the `SavedQueriesRepository` interface and `DrizzleSavedQueriesRepository` to accept and write `updatedByUserId`.

**Wire `latestVersionHash` into findById response:**

In the `findById()` method (or wherever the detail response is built for `GET /saved-queries/:id`), fetch the latest version hash:
```typescript
const latestVersion = await this.queryVersionsRepository.findLatestBySavedQueryId(id);
const latestVersionHash = latestVersion?.sqlTextHash ?? null;
```
Include `latestVersionHash` in the returned response object. This is what the frontend captures via `useStaleDetection.trackOpened()` when a query is opened.

**Return `updatedByUserName` in responses:**

When returning saved query responses (findById, findAll, findAllListItems), JOIN with users table to get the name of the user who last updated. Add `updatedByUserName` to the response interface and map it accordingly.

**2. Update `SavedQueriesController` (`saved-queries.controller.ts`):**

Update the `toResponse()` and `toListItem()` methods to include `updatedByUserName` and `latestVersionHash` in the response.

**Important notes:**
- The STALE_CONTENT error code was already defined in Plan 01 Task 3 (error-codes.ts, error-messages.ts, error-policy.ts). This task only uses it — no error code file changes needed here.
- Query-activities endpoints are NOT modified in this plan. `deployToAutomation` continues to gate linking as it does today per the locked CONTEXT.md decision: "deployToAutomation continues to gate linking as it does today — no re-gating migration needed."
  </action>
  <verify>
Run `pnpm --filter api test` to verify all API tests pass. Run `pnpm typecheck` to verify type safety. Verify the STALE_CONTENT error code is used correctly in saved-queries.service.ts.
  </verify>
  <done>
- `SavedQueriesService.update()` checks `expectedHash` and throws `STALE_CONTENT` (409) on mismatch
- `updatedByUserId` is set on every save to the current user's ID
- `updatedByUserName` is returned in saved query responses (joined from users table)
- `latestVersionHash` is returned in `GET /saved-queries/:id` response from latest query_versions row
- Query-activities controller is UNCHANGED — `deployToAutomation` continues to gate link/unlink/publish/drift/blast per locked decision
- All API tests pass, typecheck clean
  </done>
</task>

</tasks>

<verification>
1. `pnpm --filter api test` passes (all existing + new behavior)
2. `pnpm typecheck` passes across all packages
3. Shared folder create with `visibility: 'shared'` returns 200 for Enterprise, FEATURE_NOT_ENABLED for Pro/Free
4. Save with stale `expectedHash` returns 409 Conflict
5. `GET /folders` returns `visibility`, `userId`, `creatorName` in response
6. `GET /saved-queries/:id` returns `latestVersionHash` in response
7. Pro-tier `POST /query-activities/link/:id` continues to work (gated by `deployToAutomation`, unchanged)
8. Pro-tier `POST /query-activities` (deploy) still succeeds
</verification>

<success_criteria>
- Shared folder CRUD gated behind teamCollaboration (Enterprise only)
- Stale detection prevents concurrent save conflicts on shared queries
- Query-activities endpoints unchanged — deployToAutomation gates link/publish/drift/blast as before
- All responses include new fields (visibility, creatorName, updatedByUserName, latestVersionHash)
</success_criteria>

<output>
After completion, create `.planning/phases/18-shared-query-workspaces/18-02-SUMMARY.md`
</output>
